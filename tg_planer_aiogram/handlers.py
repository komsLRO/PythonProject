from datetime import datetime, timedelta
from aiogram import Dispatcher
from aiogram.filters import Command, StateFilter
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from aiogram.types import Message

import database
import utils


class AddTaskStates(StatesGroup):
    waiting_for_title = State()
    waiting_for_datetime = State()


class ClearAllStates(StatesGroup):
    waiting_for_confirmation = State()


def register_handlers(dp: Dispatcher):
    # ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹
    dp.message.register(on_start, Command("start"))
    dp.message.register(on_help, Command("help"))
    dp.message.register(on_add, Command("add"))
    dp.message.register(on_today, Command("today"))
    dp.message.register(on_week, Command("week"))
    dp.message.register(on_list, Command("list"))
    dp.message.register(on_cleanup, Command("cleanup"))
    dp.message.register(on_clear_all, Command("clear_all"))
    dp.message.register(on_reset_ids, Command("reset_ids"))
    dp.message.register(on_done, Command("done"))
    dp.message.register(on_undo, Command("undo"))
    dp.message.register(on_delete, Command("delete"))
    dp.message.register(on_search, Command("search"))

    # Ğ”Ğ¸Ğ°Ğ»Ğ¾Ğ³ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸
    dp.message.register(process_title, StateFilter(AddTaskStates.waiting_for_title))
    dp.message.register(process_datetime, StateFilter(AddTaskStates.waiting_for_datetime))

    # Ğ”Ğ¸Ğ°Ğ»Ğ¾Ğ³ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ Ğ²ÑĞµÑ… Ğ·Ğ°Ğ´Ğ°Ñ‡
    dp.message.register(process_clear_confirmation, StateFilter(ClearAllStates.waiting_for_confirmation))

    # ĞÑ‚Ğ¼ĞµĞ½Ğ° Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ°
    dp.message.register(cancel_add, Command("cancel"))


async def on_start(message: Message):
    await database.register_user(message.from_user.id, message.from_user.username)

    msg = (
        "ğŸ‰ <b>Ğ”Ğ¾Ğ±Ñ€Ğ¾ Ğ¿Ğ¾Ğ¶Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ² Telegram Planner Bot!</b> ğŸ¤–\n\n"
        "Ğ¯ Ğ¿Ğ¾Ğ¼Ğ¾Ğ³Ñƒ Ğ²Ğ°Ğ¼ Ğ¾Ñ€Ğ³Ğ°Ğ½Ğ¸Ğ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ´ĞµĞ»Ğ° Ğ¸ Ğ½Ğµ Ğ·Ğ°Ğ±Ñ‹Ñ‚ÑŒ Ğ²Ğ°Ğ¶Ğ½Ñ‹Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸.\n\n"
        "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
        "<b>ğŸš€ Ğ‘Ğ«Ğ¡Ğ¢Ğ Ğ«Ğ™ Ğ¡Ğ¢ĞĞ Ğ¢:</b>\n"
        "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
        "1ï¸âƒ£ <b>/add</b> - Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ ÑĞ²Ğ¾Ñ Ğ¿ĞµÑ€Ğ²ÑƒÑ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ\n"
        "2ï¸âƒ£ <b>/today</b> - ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸Ñ‚Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ğ½Ğ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ\n"
        "3ï¸âƒ£ <b>/help</b> - ĞŸĞ¾Ğ´Ñ€Ğ¾Ğ±Ğ½Ğ°Ñ ÑĞ¿Ñ€Ğ°Ğ²ĞºĞ° Ğ¿Ğ¾ Ğ²ÑĞµĞ¼ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ°Ğ¼\n\n"

        "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
        "<b>ğŸ“‹ ĞĞ¡ĞĞĞ’ĞĞ«Ğ• ĞšĞĞœĞĞĞ”Ğ«:</b>\n"
        "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
        "â• /add â€” Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ\n"
        "ğŸ“… /today â€” Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ğ½Ğ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ\n"
        "ğŸ“† /week â€” Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ğ½Ğ° Ğ½ĞµĞ´ĞµĞ»Ñ\n"
        "ğŸ“‹ /list â€” Ğ²ÑĞµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸\n"
        "âœ… /done N â€” Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ â„–N\n"
        "ğŸ—‘ï¸ /delete N â€” ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ â„–N\n"
        "ğŸ” /search â€” Ğ½Ğ°Ğ¹Ñ‚Ğ¸ Ğ¿Ğ¾Ñ…Ğ¾Ğ¶Ğ¸Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸\n\n"

        "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
        "<b>ğŸ’¡ ĞŸĞĞ›Ğ•Ğ—ĞĞ«Ğ• Ğ¡Ğ’Ğ•Ğ”Ğ•ĞĞ˜Ğ¯:</b>\n"
        "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
        "â€¢ <b>Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ´Ğ°Ñ‚:</b> <code>DD.MM.YYYY HH:MM</code>\n"
        "â€¢ <b>ĞÑƒĞ¼ĞµÑ€Ğ°Ñ†Ğ¸Ñ:</b> ĞŸĞ¾ Ğ¿Ğ¾Ñ€ÑĞ´ĞºÑƒ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ\n"
        "â€¢ <b>ĞĞ²Ñ‚Ğ¾Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞ°:</b> ĞŸÑ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ½Ñ‹Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ ÑƒĞ´Ğ°Ğ»ÑÑÑ‚ÑÑ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸\n\n"

        "<i>Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ /help Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ´Ñ€Ğ¾Ğ±Ğ½Ğ¾Ğ¹ ÑĞ¿Ñ€Ğ°Ğ²ĞºĞ¸ ÑĞ¾ Ğ²ÑĞµĞ¼Ğ¸ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ°Ğ¼Ğ¸! ğŸ“š</i>"
    )
    await message.answer(msg)


async def on_help(message: Message):
    """ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ¿Ğ¾Ğ´Ñ€Ğ¾Ğ±Ğ½ÑƒÑ ÑĞ¿Ñ€Ğ°Ğ²ĞºÑƒ Ğ¿Ğ¾ Ğ²ÑĞµĞ¼ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ°Ğ¼"""
    help_text = (
        "ğŸ¤– <b>Telegram Planner Bot</b>\n"
        "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"

        "ğŸ“ <b>Ğ£ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ• Ğ—ĞĞ”ĞĞ§ĞĞœĞ˜</b>\n"
        "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
        "â• <b>/add</b> - Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ½Ğ¾Ğ²ÑƒÑ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ\n"
        "   Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚: <code>DD.MM.YYYY HH:MM</code>\n"
        "   ĞŸÑ€Ğ¸Ğ¼ĞµÑ€: <code>25.12.2024 14:30</code>\n\n"

        "ğŸ“… <b>/today</b> - Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ğ½Ğ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ\n"
        "ğŸ“† <b>/week</b> - Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ğ½Ğ° Ğ½ĞµĞ´ĞµĞ»Ñ\n"
        "ğŸ“‹ <b>/list</b> - Ğ’ÑĞµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ\n\n"

        "âœ… <b>/done N</b> - Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ â„–N\n"
        "â†©ï¸ <b>/undo N</b> - ĞÑ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ â„–N\n"
        "ğŸ—‘ï¸ <b>/delete N</b> - Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ â„–N\n\n"

        "ğŸ” <b>/search Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ</b> - ĞĞ°Ğ¹Ñ‚Ğ¸ Ğ¿Ğ¾Ñ…Ğ¾Ğ¶Ğ¸Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸\n"
        "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"

        "ğŸ§¹ <b>ĞĞ§Ğ˜Ğ¡Ğ¢ĞšĞ Ğ˜ Ğ¡Ğ•Ğ Ğ’Ğ˜Ğ¡</b>\n"
        "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
        "ğŸ§½ <b>/cleanup</b> - Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ½Ñ‹Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸\n"
        "ğŸ’¥ <b>/clear_all</b> - Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ’Ğ¡Ğ• Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ (Ñ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸ĞµĞ¼)\n"
        "ğŸ”„ <b>/reset_ids</b> - Ğ¡Ğ±Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ ÑÑ‡ĞµÑ‚Ñ‡Ğ¸Ğº ID Ğ·Ğ°Ğ´Ğ°Ñ‡\n"
        "âŒ <b>/cancel</b> - ĞÑ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ñ‚ĞµĞºÑƒÑ‰ÑƒÑ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ñ\n\n"

        "â“ <b>/help</b> - ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ÑÑ‚Ñƒ ÑĞ¿Ñ€Ğ°Ğ²ĞºÑƒ\n"
        "ğŸš€ <b>/start</b> - ĞšÑ€Ğ°Ñ‚ĞºĞ°Ñ ÑĞ¿Ñ€Ğ°Ğ²ĞºĞ° Ğ¸ Ğ¿Ñ€Ğ¸Ğ²ĞµÑ‚ÑÑ‚Ğ²Ğ¸Ğµ\n"
        "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"

        "ğŸ’¡ <b>Ğ’ĞĞ–ĞĞ«Ğ• Ğ—ĞĞœĞ•Ğ§ĞĞĞ˜Ğ¯:</b>\n"
        "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
        "â€¢ <b>ĞÑƒĞ¼ĞµÑ€Ğ°Ñ†Ğ¸Ñ:</b> Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ¿Ğ¾ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ\n"
        "â€¢ <b>Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ´Ğ°Ñ‚:</b> Ğ¡Ñ‚Ñ€Ğ¾Ğ³Ğ¾ <code>DD.MM.YYYY HH:MM</code>\n"
        "â€¢ <b>ĞĞ²Ñ‚Ğ¾Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞ°:</b> ĞŸÑ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ½Ñ‹Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ ÑƒĞ´Ğ°Ğ»ÑÑÑ‚ÑÑ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸\n"
        "â€¢ <b>FSM:</b> Ğ”Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ¸ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ÑÑ‚ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ Ğ¸ Ğ¾Ñ‚Ğ¼ĞµĞ½Ñƒ\n"
        "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"

        "ğŸ¯ <b>ĞŸĞ Ğ˜ĞœĞ•Ğ Ğ« Ğ˜Ğ¡ĞŸĞĞ›Ğ¬Ğ—ĞĞ’ĞĞĞ˜Ğ¯:</b>\n"
        "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
        "<b>Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸:</b>\n"
        "<code>/add</code>\n"
        "â””â”€ <i>ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ?</i> â†’ <code>Ğ’ÑÑ‚Ñ€ĞµÑ‡Ğ° Ñ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ¾Ğ¼</code>\n"
        "â””â”€ <i>Ğ”Ğ°Ñ‚Ğ° Ğ¸ Ğ²Ñ€ĞµĞ¼Ñ?</i> â†’ <code>25.12.2024 14:30</code>\n\n"

        "<b>Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ°Ğ¼Ğ¸:</b>\n"
        "<code>/done 1</code> - Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ Ğ¿ĞµÑ€Ğ²ÑƒÑ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ\n"
        "<code>/delete 2</code> - Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ²Ñ‚Ğ¾Ñ€ÑƒÑ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ\n\n"

        "<b>ĞŸÑ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ Ğ·Ğ°Ğ´Ğ°Ñ‡:</b>\n"
        "<code>/today</code> - Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ğ½Ğ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ\n"
        "<code>/week</code> - Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ğ½Ğ° Ğ½ĞµĞ´ĞµĞ»Ñ\n"
        "<code>/list</code> - Ğ’ÑĞµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸\n"
        "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"

        "ğŸ“ <b>ĞŸĞĞ”Ğ”Ğ•Ğ Ğ–ĞšĞ:</b> Ğ•ÑĞ»Ğ¸ Ğ²Ğ¾Ğ·Ğ½Ğ¸ĞºĞ»Ğ¸ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹, Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ:\n"
        "â€¢ ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ° Ğ´Ğ°Ñ‚Ñ‹ Ğ¸ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸\n"
        "â€¢ ĞĞ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… Ğ·Ğ°Ğ´Ğ°Ñ‡\n"
        "â€¢ ĞšĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾ÑÑ‚ÑŒ Ğ½Ğ¾Ğ¼ĞµÑ€Ğ¾Ğ² Ğ·Ğ°Ğ´Ğ°Ñ‡\n"
        "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    )
    await message.answer(help_text, parse_mode="HTML")


async def on_add(message: Message, state: FSMContext):
    """ĞĞ°Ñ‡Ğ°Ğ»Ğ¾ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ° Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸"""
    await state.clear()  # ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰ĞµĞµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ

    await message.answer(
        "ğŸ“ <b>Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ½Ğ¾Ğ²Ğ¾Ğ¹ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸</b>\n"
        "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"
        "âœï¸ <b>Ğ¨Ğ°Ğ³ 1:</b> Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ <b>Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸</b>\n\n"
        "ğŸ’¡ <i>ĞĞ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: Ğ’ÑÑ‚Ñ€ĞµÑ‡Ğ° Ñ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ¾Ğ¼, Ğ¡Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ Ğ´Ğ¾Ğ¼Ğ°ÑˆĞ½ĞµĞµ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ğµ</i>\n\n"
        "âŒ <code>/cancel</code> - Ğ¾Ñ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ\n"
        "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    )
    await state.set_state(AddTaskStates.waiting_for_title)


async def process_title(message: Message, state: FSMContext):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸"""
    title = message.text.strip()

    if len(title) < 1:
        await message.answer(
            "âŒ <b>ĞÑˆĞ¸Ğ±ĞºĞ°!</b>\n\n"
            "ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ğ¿ÑƒÑÑ‚Ñ‹Ğ¼!\n\n"
            "âœï¸ Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸:"
        )
        return

    if len(title) > 200:
        await message.answer(
            "âŒ <b>ĞÑˆĞ¸Ğ±ĞºĞ°!</b>\n\n"
            f"ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ ÑĞ»Ğ¸ÑˆĞºĞ¾Ğ¼ Ğ´Ğ»Ğ¸Ğ½Ğ½Ğ¾Ğµ! ({len(title)} ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ², Ğ¼Ğ°ĞºÑ. 200)\n\n"
            "âœï¸ Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ±Ğ¾Ğ»ĞµĞµ ĞºĞ¾Ñ€Ğ¾Ñ‚ĞºĞ¾Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ:"
        )
        return

    # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ² ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğ¸
    await state.update_data(title=title)

    await message.answer(
        f"âœ… <b>ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ñ€Ğ¸Ğ½ÑÑ‚Ğ¾:</b> <i>{title}</i>\n\n"
        "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"
        "ğŸ“… <b>Ğ¨Ğ°Ğ³ 2:</b> Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ <b>Ğ´Ğ°Ñ‚Ñƒ Ğ¸ Ğ²Ñ€ĞµĞ¼Ñ</b>\n\n"
        "ğŸ“ <b>Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚:</b> <code>DD.MM.YYYY HH:MM</code>\n\n"
        "ğŸ’¡ <b>ĞŸÑ€Ğ¸Ğ¼ĞµÑ€Ñ‹:</b>\n"
        "â€¢ <code>25.12.2024 14:30</code> - Ğ Ğ¾Ğ¶Ğ´ĞµÑÑ‚Ğ²Ğ¾\n"
        "â€¢ <code>01.01.2025 09:00</code> - ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ³Ğ¾Ğ´\n"
        "â€¢ <code>15.03.2024 16:45</code> - Ğ’ÑÑ‚Ñ€ĞµÑ‡Ğ°\n\n"
        "âŒ <code>/cancel</code> - Ğ¾Ñ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ\n"
        "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    )
    await state.set_state(AddTaskStates.waiting_for_datetime)


async def process_datetime(message: Message, state: FSMContext):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ´Ğ°Ñ‚Ñ‹ Ğ¸ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸ Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸"""
    datetime_input = message.text.strip()

    # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ½Ğ¾Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ
    data = await state.get_data()
    title = data.get('title')

    # Ğ Ğ°Ğ·Ğ´ĞµĞ»ÑĞµĞ¼ Ğ´Ğ°Ñ‚Ñƒ Ğ¸ Ğ²Ñ€ĞµĞ¼Ñ (Ğ¾Ğ¶Ğ¸Ğ´Ğ´Ğ°ĞµĞ¼ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ "DD.MM.YYYY HH:MM")
    parts = datetime_input.split()
    if len(parts) != 2:
        await message.answer(
            "âŒ <b>ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ´Ğ°Ñ‚Ñ‹ Ğ¸ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸!</b>\n\n"
            "ğŸ“ <b>ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚:</b> <code>DD.MM.YYYY HH:MM</code>\n\n"
            "ğŸ’¡ <b>ĞŸÑ€Ğ¸Ğ¼ĞµÑ€Ñ‹:</b>\n"
            "â€¢ <code>25.12.2024 14:30</code>\n"
            "â€¢ <code>01.01.2025 09:00</code>\n\n"
            "ğŸ”„ Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ´Ğ°Ñ‚Ñƒ Ğ¸ Ğ²Ñ€ĞµĞ¼Ñ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾:"
        )
        return

    date_input, time_input = parts

    # ĞŸĞ°Ñ€ÑĞ¸Ğ¼ Ğ´Ğ°Ñ‚Ñƒ Ğ¸ Ğ²Ñ€ĞµĞ¼Ñ
    parsed = utils.parse_date_time(date_input, time_input)
    if parsed is None:
        await message.answer(
            "âŒ <b>ĞĞµĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ°Ñ Ğ´Ğ°Ñ‚Ğ° Ğ¸Ğ»Ğ¸ Ğ²Ñ€ĞµĞ¼Ñ!</b>\n\n"
            "ğŸ“… ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚: <code>DD.MM.YYYY HH:MM</code>\n\n"
            "ğŸ’¡ <b>ĞŸÑ€Ğ¸Ğ¼ĞµÑ€Ñ‹ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ñ… Ğ´Ğ°Ñ‚:</b>\n"
            "â€¢ <code>25.12.2024 14:30</code>\n"
            "â€¢ <code>01.01.2025 09:15</code>\n\n"
            "ğŸ”„ Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½ÑƒÑ Ğ´Ğ°Ñ‚Ñƒ Ğ¸ Ğ²Ñ€ĞµĞ¼Ñ:"
        )
        return

    date_str, time_str = parsed

    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ Ğ²Ñ€ĞµĞ¼Ñ Ğ½Ğµ Ğ² Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ¾Ğ¼
    if not utils.validate_datetime(date_str, time_str):
        await message.answer(
            "â° <b>ĞĞµĞ»ÑŒĞ·Ñ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ Ğ½Ğ° Ğ¿Ñ€Ğ¾ÑˆĞµĞ´ÑˆĞµĞµ Ğ²Ñ€ĞµĞ¼Ñ!</b>\n\n"
            "ğŸ“… Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ´Ğ°Ñ‚Ñƒ Ğ¸ Ğ²Ñ€ĞµĞ¼Ñ Ğ² Ğ±ÑƒĞ´ÑƒÑ‰ĞµĞ¼.\n\n"
            "ğŸ’¡ <i>Ğ¢ĞµĞºÑƒÑ‰ĞµĞµ Ğ²Ñ€ĞµĞ¼Ñ Ğ±ÑƒĞ´ĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞµĞ½Ğ¾ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸</i>\n\n"
            "ğŸ”„ Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ´Ğ°Ñ‚Ñƒ Ğ¸ Ğ²Ñ€ĞµĞ¼Ñ Ğ² Ğ±ÑƒĞ´ÑƒÑ‰ĞµĞ¼:"
        )
        await state.clear()
        return

    # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ
    vec = utils.make_embedding(title)
    blob = utils.emb_to_blob(vec)
    task_id = await database.insert_task(message.from_user.id, title, date_str, time_str, blob)

    formatted_datetime = utils.format_datetime_display(date_str, time_str)
    await message.answer(
        "ğŸ‰ <b>Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ° ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ°!</b>\n"
        "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"
        f"ğŸ†” <b>ID:</b> {task_id}\n"
        f"ğŸ“ <b>Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ°:</b> {title}\n"
        f"ğŸ“… <b>ĞšĞ¾Ğ³Ğ´Ğ°:</b> <code>{formatted_datetime}</code>\n\n"
        "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"
        f"ğŸ’¡ <i>Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ /done {task_id} ĞºĞ¾Ğ³Ğ´Ğ° Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ</i>"
    )

    # ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ
    await state.clear()


async def cancel_add(message: Message, state: FSMContext):
    """ĞÑ‚Ğ¼ĞµĞ½Ğ° Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸"""
    await state.clear()
    await message.answer(
        "âŒ <b>ĞĞ¿ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ¾Ñ‚Ğ¼ĞµĞ½ĞµĞ½Ğ°</b>\n"
        "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"
        "ğŸš« <i>Ğ¢ĞµĞºÑƒÑ‰Ğ°Ñ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€ĞµÑ€Ğ²Ğ°Ğ½Ğ°</i>\n\n"
        "ğŸ’¡ <i>Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ /help Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ° ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´</i>\n"
        "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    )


async def on_today(message: Message):
    # Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° ÑƒĞ´Ğ°Ğ»ÑĞµĞ¼ Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ½Ñ‹Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸
    deleted_count = await database.delete_expired_tasks()
    if deleted_count > 0:
        log.info(f"Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¾ {deleted_count} Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ½Ñ‹Ñ… Ğ·Ğ°Ğ´Ğ°Ñ‡")

    today = utils.current_date()
    tasks = await database.fetch_tasks_for_date(message.from_user.id, today)

    if not tasks:
        await message.answer(
            "ğŸ“… <b>Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ğ½Ğ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ</b>\n"
            "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"
            "âœ… <i>ĞĞ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ Ğ·Ğ°Ğ´Ğ°Ñ‡ Ğ½ĞµÑ‚! ĞÑ‚Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ Ğ´ĞµĞ½ÑŒ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ´Ñ‹Ñ…Ğ° ğŸ‰</i>\n\n"
            "ğŸ’¡ <i>Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ /add Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ</i>"
        )
    else:
        formatted_date = utils.format_date_display(today)
        lines = [
            f"ğŸ“… <b>Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ğ½Ğ° {formatted_date}</b>",
            "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        ]

        for i, (task_id, title, time_str, status) in enumerate(tasks, 1):
            if status == "done":
                mark = "âœ…"
                emoji = "â˜‘ï¸"
            else:
                mark = "â³"
                emoji = "ğŸ“"

            formatted_datetime = utils.format_datetime_display(today.strftime("%Y-%m-%d"), time_str)
            lines.append(f"{emoji} <b>{i}.</b> <code>{formatted_datetime}</code> - {title} {mark}")

        lines.extend([
            "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”",
            f"ğŸ’¡ <i>Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ /done N Ğ´Ğ»Ñ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸</i>"
        ])

        await message.answer("\n".join(lines))


async def on_week(message: Message):
    """ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ğ½Ğ° Ğ½ĞµĞ´ĞµĞ»Ñ Ğ²Ğ¿ĞµÑ€ĞµĞ´"""
    # Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° ÑƒĞ´Ğ°Ğ»ÑĞµĞ¼ Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ½Ñ‹Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸
    deleted_count = await database.delete_expired_tasks()
    if deleted_count > 0:
        log.info(f"Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¾ {deleted_count} Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ½Ñ‹Ñ… Ğ·Ğ°Ğ´Ğ°Ñ‡")

    today = datetime.now().date()
    week_dates = [(today + timedelta(days=i)).strftime("%Y-%m-%d") for i in range(7)]

    tasks = await database.fetch_tasks_for_dates(message.from_user.id, week_dates)

    if not tasks:
        await message.answer(
            "ğŸ“† <b>Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ğ½Ğ° Ğ½ĞµĞ´ĞµĞ»Ñ</b>\n"
            "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"
            "âœ… <i>ĞĞ° ÑÑ‚Ğ¾Ğ¹ Ğ½ĞµĞ´ĞµĞ»Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡ Ğ½ĞµÑ‚! Ğ¡Ğ²Ğ¾Ğ±Ğ¾Ğ´Ğ½Ğ¾Ğµ Ğ²Ñ€ĞµĞ¼Ñ ğŸ‰</i>\n\n"
            "ğŸ’¡ <i>Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ /add Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ·Ğ°Ğ¿Ğ»Ğ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ´ĞµĞ»Ğ°</i>"
        )
        return

    # Ğ“Ñ€ÑƒĞ¿Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ğ¾ Ğ´Ğ°Ñ‚Ğ°Ğ¼
    tasks_by_date = {}
    for task_id, title, date_str, time_str, status in tasks:
        if date_str not in tasks_by_date:
            tasks_by_date[date_str] = []
        tasks_by_date[date_str].append((task_id, title, time_str, status))

    lines = [
        "ğŸ“† <b>Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ğ½Ğ° Ğ½ĞµĞ´ĞµĞ»Ñ</b>",
        "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    ]

    for date_str in sorted(tasks_by_date.keys()):
        formatted_date = utils.format_date_display(date_str)
        lines.append(f"\nğŸ“… <b>{formatted_date}:</b>")

        for i, (task_id, title, time_str, status) in enumerate(tasks_by_date[date_str], 1):
            if status == "done":
                mark = "âœ…"
                emoji = "â˜‘ï¸"
            else:
                mark = "â³"
                emoji = "ğŸ“"

            formatted_datetime = utils.format_datetime_display(date_str, time_str)
            lines.append(f"  {emoji} <b>{i}.</b> <code>{formatted_datetime}</code> - {title} {mark}")

    lines.extend([
        "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”",
        "ğŸ’¡ <i>ĞĞ¾Ğ¼ĞµÑ€Ğ° Ğ·Ğ°Ğ´Ğ°Ñ‡ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ² Ğ¿Ñ€ĞµĞ´ĞµĞ»Ğ°Ñ… Ğ´Ğ½Ñ</i>"
    ])

    await message.answer("\n".join(lines))


async def on_list(message: Message):
    """ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ²ÑĞµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ"""
    # Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° ÑƒĞ´Ğ°Ğ»ÑĞµĞ¼ Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ½Ñ‹Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸
    deleted_count = await database.delete_expired_tasks()
    if deleted_count > 0:
        await message.answer(f"ğŸ—‘ï¸ Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¾ {deleted_count} Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ½Ñ‹Ñ… Ğ·Ğ°Ğ´Ğ°Ñ‡")

    tasks = await database.fetch_all_tasks(message.from_user.id)

    if not tasks:
        await message.answer(
            "ğŸ“ <b>Ğ’ÑĞµ Ğ²Ğ°ÑˆĞ¸ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸</b>\n"
            "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"
            "ğŸ“­ <i>Ğ£ Ğ²Ğ°Ñ Ğ¿Ğ¾ĞºĞ° Ğ½ĞµÑ‚ Ğ·Ğ°Ğ´Ğ°Ñ‡</i>\n\n"
            "ğŸ’¡ <i>Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ /add Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿ĞµÑ€Ğ²ÑƒÑ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ</i>"
        )
        return

    lines = [
        "ğŸ“‹ <b>Ğ’ÑĞµ Ğ²Ğ°ÑˆĞ¸ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸</b>",
        "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    ]

    # Ğ“Ñ€ÑƒĞ¿Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ğ¾ ÑÑ‚Ğ°Ñ‚ÑƒÑÑƒ Ñ Ğ¿Ğ¾Ñ€ÑĞ´ĞºĞ¾Ğ²Ğ¾Ğ¹ Ğ½ÑƒĞ¼ĞµÑ€Ğ°Ñ†Ğ¸ĞµĞ¹
    pending_tasks = []
    done_tasks = []

    task_number = 1
    for task_id, title, date_str, time_str, status in tasks:
        formatted_datetime = utils.format_datetime_display(date_str, time_str)

        if status == "done":
            emoji = "â˜‘ï¸"
            mark = "âœ…"
            done_tasks.append(f"  {emoji} <b>{task_number}.</b> <code>{formatted_datetime}</code> - {title} {mark}")
        else:
            emoji = "ğŸ“"
            mark = "â³"
            pending_tasks.append(f"  {emoji} <b>{task_number}.</b> <code>{formatted_datetime}</code> - {title} {mark}")

        task_number += 1

    # ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ ÑĞ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ½ĞµĞ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ½Ñ‹Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸
    if pending_tasks:
        lines.extend([
            f"\nğŸ”„ <b>ĞĞµĞ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ½Ñ‹Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ ({len(pending_tasks)}):</b>",
            "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        ])
        lines.extend(pending_tasks[:20])  # ĞĞ³Ñ€Ğ°Ğ½Ğ¸Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾

    if done_tasks:
        lines.extend([
            f"\nâœ… <b>Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ½Ñ‹Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ ({len(done_tasks)}):</b>",
            "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        ])
        lines.extend(done_tasks[:10])  # ĞœĞµĞ½ÑŒÑˆĞµ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ½Ñ‹Ñ… Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼

    lines.extend([
        "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”",
        f"ğŸ’¡ <i>Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ /done N Ğ´Ğ»Ñ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ Ğ·Ğ°Ğ´Ğ°Ñ‡</i>"
    ])

    if len(pending_tasks) > 20 or len(done_tasks) > 10:
        lines.append(f"ğŸ’¡ <i>ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ğ½Ñ‹ Ğ½Ğµ Ğ²ÑĞµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸. Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ /today Ğ¸Ğ»Ğ¸ /week Ğ´Ğ»Ñ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸</i>")

    await message.answer("\n".join(lines))


async def on_cleanup(message: Message):
    """Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ²ÑĞµ Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ½Ñ‹Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸"""
    deleted_count = await database.delete_expired_tasks()

    if deleted_count > 0:
        await message.answer(
            f"ğŸ§½ <b>ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°!</b>\n"
            "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"
            f"ğŸ—‘ï¸ Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¾ Ğ¿Ñ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ½Ñ‹Ñ… Ğ·Ğ°Ğ´Ğ°Ñ‡: <b>{deleted_count}</b>\n\n"
            "âœ… <i>Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ·Ğ°Ğ´Ğ°Ñ‡ Ğ¾Ñ‡Ğ¸Ñ‰ĞµĞ½ Ğ¾Ñ‚ ÑÑ‚Ğ°Ñ€Ñ‹Ñ… Ğ·Ğ°Ğ´Ğ°Ñ‡</i>\n"
            "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        )
    else:
        await message.answer(
            "ğŸ§½ <b>ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° ÑĞ¿Ğ¸ÑĞºĞ° Ğ·Ğ°Ğ´Ğ°Ñ‡</b>\n"
            "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"
            "âœ… <i>ĞŸÑ€Ğ¾ÑÑ€Ğ¾Ñ‡ĞµĞ½Ğ½Ñ‹Ñ… Ğ·Ğ°Ğ´Ğ°Ñ‡ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾</i>\n\n"
            "ğŸ‰ <i>Ğ’Ğ°Ñˆ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ·Ğ°Ğ´Ğ°Ñ‡ Ğ² Ğ¿Ğ¾Ñ€ÑĞ´ĞºĞµ!</i>\n"
            "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        )


async def on_reset_ids(message: Message):
    """Ğ¡Ğ±Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ ÑÑ‡ĞµÑ‚Ñ‡Ğ¸Ğº ID Ğ·Ğ°Ğ´Ğ°Ñ‡"""
    task_count = await database.count_user_tasks(message.from_user.id)

    if task_count == 0:
        # Ğ•ÑĞ»Ğ¸ Ğ·Ğ°Ğ´Ğ°Ñ‡ Ğ½ĞµÑ‚, ÑĞ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ĞµĞ¼ ÑÑ‡ĞµÑ‚Ñ‡Ğ¸Ğº Ğ½Ğ° 1
        await database.reset_task_ids()
        await message.answer(
            "ğŸ”„ <b>Ğ¡Ğ±Ñ€Ğ¾Ñ ID ÑÑ‡ĞµÑ‚Ñ‡Ğ¸ĞºĞ°</b>\n"
            "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"
            "âœ… ID ÑÑ‡ĞµÑ‚Ñ‡Ğ¸Ğº ÑĞ±Ñ€Ğ¾ÑˆĞµĞ½ Ğ½Ğ° 1\n"
            "ğŸ“­ ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… Ğ·Ğ°Ğ´Ğ°Ñ‡: 0\n\n"
            "ğŸ’¡ <i>ĞĞ¾Ğ²Ñ‹Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ğ±ÑƒĞ´ÑƒÑ‚ Ğ¸Ğ¼ĞµÑ‚ÑŒ ID Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°Ñ Ñ 1</i>\n"
            "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        )
        return

    # Ğ•ÑĞ»Ğ¸ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ ĞµÑÑ‚ÑŒ, ÑƒÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ ÑÑ‡ĞµÑ‚Ñ‡Ğ¸Ğº Ğ½Ğ° ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğ¹ Ğ¿Ğ¾ÑĞ»Ğµ Ğ¼Ğ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ ID
    await database.reset_task_ids()
    await message.answer(
        f"ğŸ”„ <b>ĞĞ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ ID ÑÑ‡ĞµÑ‚Ñ‡Ğ¸ĞºĞ°</b>\n"
        f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"
        f"âœ… ID ÑÑ‡ĞµÑ‚Ñ‡Ğ¸Ğº Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½\n"
        f"ğŸ“Š ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… Ğ·Ğ°Ğ´Ğ°Ñ‡: <b>{task_count}</b>\n\n"
        f"ğŸ’¡ <i>ĞĞ¾Ğ²Ñ‹Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ğ±ÑƒĞ´ÑƒÑ‚ Ğ¸Ğ¼ĞµÑ‚ÑŒ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ ID</i>\n"
        f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    )


async def on_clear_all(message: Message, state: FSMContext):
    """ĞĞ°Ñ‡Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ Ğ²ÑĞµÑ… Ğ·Ğ°Ğ´Ğ°Ñ‡ Ñ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸ĞµĞ¼"""
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, ĞµÑÑ‚ÑŒ Ğ»Ğ¸ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ñƒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
    task_count = await database.count_user_tasks(message.from_user.id)

    if task_count == 0:
        await message.answer(
            "ğŸ“­ <b>Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ğ²ÑĞµÑ… Ğ·Ğ°Ğ´Ğ°Ñ‡</b>\n"
            "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"
            "âŒ <i>Ğ£ Ğ²Ğ°Ñ Ğ½ĞµÑ‚ Ğ·Ğ°Ğ´Ğ°Ñ‡ Ğ´Ğ»Ñ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ</i>\n\n"
            "ğŸ’¡ <i>Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ñ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒÑ /add</i>\n"
            "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        )
        return

    # ĞŸÑ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ¸ Ğ·Ğ°Ğ¿Ñ€Ğ°ÑˆĞ¸Ğ²Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ
    await message.answer(
        f"âš ï¸ <b>ĞšĞ Ğ˜Ğ¢Ğ˜Ğ§Ğ•Ğ¡ĞšĞĞ• ĞŸĞ Ğ•Ğ”Ğ£ĞŸĞ Ğ•Ğ–Ğ”Ğ•ĞĞ˜Ğ•!</b>\n"
        f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"
        f"ğŸ’¥ Ğ’Ñ‹ ÑĞ¾Ğ±Ğ¸Ñ€Ğ°ĞµÑ‚ĞµÑÑŒ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ <b>Ğ’Ğ¡Ğ• {task_count} Ğ·Ğ°Ğ´Ğ°Ñ‡</b>!\n\n"
        f"ğŸ”´ <b>Ğ­Ğ¢Ğ Ğ”Ğ•Ğ™Ğ¡Ğ¢Ğ’Ğ˜Ğ• ĞĞ•Ğ›Ğ¬Ğ—Ğ¯ ĞĞ¢ĞœĞ•ĞĞ˜Ğ¢Ğ¬!</b>\n\n"
        f"ğŸ“Š Ğ‘ÑƒĞ´ĞµÑ‚ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¾:\n"
        f"â€¢ Ğ’ÑĞµ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ½Ñ‹Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸\n"
        f"â€¢ Ğ’ÑĞµ Ğ½ĞµĞ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ½Ñ‹Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸\n"
        f"â€¢ Ğ’ÑÑ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¿Ğ»Ğ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ\n\n"
        f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"
        f"âœ… <b>ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ:</b>\n"
        f"Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ: <code>Ğ”Ğ Ğ£Ğ”ĞĞ›Ğ˜Ğ¢Ğ¬ Ğ’Ğ¡Ğ•</code>\n\n"
        f"âŒ <b>ĞÑ‚Ğ¼ĞµĞ½Ğ°:</b>\n"
        f"Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ: <code>ĞĞ•Ğ¢</code> Ğ¸Ğ»Ğ¸ <code>/cancel</code>\n"
        f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    )

    # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ
    await state.update_data(task_count=task_count)
    await state.set_state(ClearAllStates.waiting_for_confirmation)


async def process_clear_confirmation(message: Message, state: FSMContext):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ Ğ²ÑĞµÑ… Ğ·Ğ°Ğ´Ğ°Ñ‡"""
    confirmation = message.text.strip().upper()

    if confirmation == "Ğ”Ğ Ğ£Ğ”ĞĞ›Ğ˜Ğ¢Ğ¬ Ğ’Ğ¡Ğ•":
        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ·Ğ°Ğ´Ğ°Ñ‡
        data = await state.get_data()
        expected_count = data.get('task_count', 0)

        # Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ Ğ²ÑĞµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸
        deleted_count = await database.delete_all_tasks(message.from_user.id)

        await message.answer(
            f"ğŸ’¥ <b>Ğ’Ğ¡Ğ• Ğ—ĞĞ”ĞĞ§Ğ˜ Ğ£Ğ”ĞĞ›Ğ•ĞĞ«!</b>\n"
            f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"
            f"ğŸ—‘ï¸ Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¾ Ğ·Ğ°Ğ´Ğ°Ñ‡: <b>{deleted_count}</b>\n\n"
            f"ğŸ”„ ID ÑÑ‡ĞµÑ‚Ñ‡Ğ¸Ğº ÑĞ±Ñ€Ğ¾ÑˆĞµĞ½ Ğ½Ğ° 1\n\n"
            f"âœ… <i>Ğ‘Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ğ»Ğ½Ğ¾ÑÑ‚ÑŒÑ Ğ¾Ñ‡Ğ¸Ñ‰ĞµĞ½Ğ°</i>\n"
            f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"
            f"ğŸ’¡ <i>Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ /add Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ñ‹Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸</i>"
        )

        # ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ
        await state.clear()

    elif confirmation in ["ĞĞ•Ğ¢", "NO", "CANCEL", "ĞĞ¢ĞœĞ•ĞĞ"]:
        await message.answer(
            "âœ… <b>Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾Ñ‚Ğ¼ĞµĞ½ĞµĞ½Ğ¾</b>\n"
            "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"
            "ğŸ‰ <i>Ğ’ÑĞµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ñ‹</i>\n\n"
            "ğŸ’¡ <i>Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ /list Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸</i>\n"
            "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        )
        await state.clear()

    else:
        await message.answer(
            "âŒ <b>ĞĞµĞ²ĞµÑ€Ğ½Ğ¾Ğµ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ!</b>\n"
            "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"
            "ğŸ“ <b>Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ğµ Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚Ñ‹:</b>\n\n"
            "âœ… <b>ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚ÑŒ:</b> <code>Ğ”Ğ Ğ£Ğ”ĞĞ›Ğ˜Ğ¢Ğ¬ Ğ’Ğ¡Ğ•</code>\n"
            "âŒ <b>ĞÑ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ:</b> <code>ĞĞ•Ğ¢</code> Ğ¸Ğ»Ğ¸ <code>/cancel</code>\n\n"
            "ğŸ”„ ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ñ‚Ğµ Ğ²Ğ²Ğ¾Ğ´:\n"
            "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        )


async def on_done(message: Message):
    # Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚: /done ID (Ğ³Ğ´Ğµ ID - Ğ¿Ğ¾Ñ€ÑĞ´ĞºĞ¾Ğ²Ñ‹Ğ¹ Ğ½Ğ¾Ğ¼ĞµÑ€ Ğ² ÑĞ¿Ğ¸ÑĞºĞµ Ğ·Ğ°Ğ´Ğ°Ñ‡)
    try:
        display_id = int(message.text.split(" ", 1)[1])
    except (ValueError, IndexError):
        await message.answer("ĞÑƒĞ¶Ğ½Ğ¾ ÑƒĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ½Ğ¾Ğ¼ĞµÑ€ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸.\nĞŸÑ€Ğ¸Ğ¼ĞµÑ€: /done 1")
        return

    # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ²ÑĞµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ, Ğ¾Ñ‚ÑĞ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸
    tasks = await database.fetch_all_tasks(message.from_user.id, 1000)  # Ğ‘Ğ¾Ğ»ÑŒÑˆĞµ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ¸ÑĞºĞ°

    if display_id < 1 or display_id > len(tasks):
        await message.answer(f"Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ° Ñ Ğ½Ğ¾Ğ¼ĞµÑ€Ğ¾Ğ¼ {display_id} Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°.")
        return

    # ĞĞ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ Ğ¿Ğ¾ Ğ¿Ğ¾Ñ€ÑĞ´ĞºĞ¾Ğ²Ğ¾Ğ¼Ñƒ Ğ½Ğ¾Ğ¼ĞµÑ€Ñƒ
    real_task_id = tasks[display_id - 1][0]  # ĞŸĞµÑ€Ğ²Ñ‹Ğ¹ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚ - ÑÑ‚Ğ¾ ID Ğ² Ğ±Ğ°Ğ·Ğµ

    count = await database.mark_task_done(message.from_user.id, real_task_id)
    if count > 0:
        await message.answer(
            f"âœ… <b>Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ° Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ°!</b>\n\n"
            f"ğŸ¯ Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ° â„–{display_id} Ğ¾Ñ‚Ğ¼ĞµÑ‡ĞµĞ½Ğ° ĞºĞ°Ğº Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ½Ğ°Ñ\n\n"
            f"ğŸ’¡ <i>Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ /undo {display_id} ĞµÑĞ»Ğ¸ Ğ¿ĞµÑ€ĞµĞ´ÑƒĞ¼Ğ°Ğ»Ğ¸</i>"
        )
    else:
        await message.answer(
            "âŒ <b>ĞÑˆĞ¸Ğ±ĞºĞ° Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸</b>\n\n"
            "Ğ’Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ¸Ñ‡Ğ¸Ğ½Ñ‹:\n"
            "â€¢ Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ° ÑƒĞ¶Ğµ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ°\n"
            "â€¢ Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ° Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°\n"
            "â€¢ ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ğ½Ğ¾Ğ¼ĞµÑ€ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸\n\n"
            "ğŸ’¡ <i>ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ·Ğ°Ğ´Ğ°Ñ‡ Ñ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒÑ /list</i>"
        )


async def on_undo(message: Message):
    # Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚: /undo ID (Ğ³Ğ´Ğµ ID - Ğ¿Ğ¾Ñ€ÑĞ´ĞºĞ¾Ğ²Ñ‹Ğ¹ Ğ½Ğ¾Ğ¼ĞµÑ€ Ğ² ÑĞ¿Ğ¸ÑĞºĞµ Ğ·Ğ°Ğ´Ğ°Ñ‡)
    try:
        display_id = int(message.text.split(" ", 1)[1])
    except (ValueError, IndexError):
        await message.answer("ĞÑƒĞ¶Ğ½Ğ¾ ÑƒĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ½Ğ¾Ğ¼ĞµÑ€ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸.\nĞŸÑ€Ğ¸Ğ¼ĞµÑ€: /undo 1")
        return

    # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ²ÑĞµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ, Ğ¾Ñ‚ÑĞ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸
    tasks = await database.fetch_all_tasks(message.from_user.id, 1000)

    if display_id < 1 or display_id > len(tasks):
        await message.answer(f"Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ° Ñ Ğ½Ğ¾Ğ¼ĞµÑ€Ğ¾Ğ¼ {display_id} Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°.")
        return

    # ĞĞ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ Ğ¿Ğ¾ Ğ¿Ğ¾Ñ€ÑĞ´ĞºĞ¾Ğ²Ğ¾Ğ¼Ñƒ Ğ½Ğ¾Ğ¼ĞµÑ€Ñƒ
    real_task_id = tasks[display_id - 1][0]

    count = await database.mark_task_undo(message.from_user.id, real_task_id)
    if count > 0:
        await message.answer(
            f"â†©ï¸ <b>Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ° Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰ĞµĞ½Ğ°!</b>\n\n"
            f"ğŸ”„ Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ° â„–{display_id} ÑĞ½Ğ¾Ğ²Ğ° Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ°\n\n"
            f"ğŸ’¡ <i>Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ /done {display_id} Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ ĞµÑ‘ ÑĞ½Ğ¾Ğ²Ğ°</i>"
        )
    else:
        await message.answer(
            "âŒ <b>ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¼ĞµĞ½Ñ‹ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ</b>\n\n"
            "Ğ’Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ¸Ñ‡Ğ¸Ğ½Ñ‹:\n"
            "â€¢ Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ° ĞµÑ‰Ñ‘ Ğ½Ğµ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ°\n"
            "â€¢ Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ° Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°\n"
            "â€¢ ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ğ½Ğ¾Ğ¼ĞµÑ€ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸\n\n"
            "ğŸ’¡ <i>ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ·Ğ°Ğ´Ğ°Ñ‡ Ñ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒÑ /list</i>"
        )


async def on_delete(message: Message):
    """Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ"""
    try:
        display_id = int(message.text.split(" ", 1)[1])
    except (ValueError, IndexError):
        await message.answer("ĞÑƒĞ¶Ğ½Ğ¾ ÑƒĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ½Ğ¾Ğ¼ĞµÑ€ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸.\nĞŸÑ€Ğ¸Ğ¼ĞµÑ€: /delete 1")
        return

    # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ²ÑĞµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ, Ğ¾Ñ‚ÑĞ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸
    tasks = await database.fetch_all_tasks(message.from_user.id, 1000)

    if display_id < 1 or display_id > len(tasks):
        await message.answer(f"Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ° Ñ Ğ½Ğ¾Ğ¼ĞµÑ€Ğ¾Ğ¼ {display_id} Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°.")
        return

    # ĞĞ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ Ğ¿Ğ¾ Ğ¿Ğ¾Ñ€ÑĞ´ĞºĞ¾Ğ²Ğ¾Ğ¼Ñƒ Ğ½Ğ¾Ğ¼ĞµÑ€Ñƒ
    real_task_id = tasks[display_id - 1][0]

    count = await database.delete_task(message.from_user.id, real_task_id)
    if count > 0:
        await message.answer(
            f"ğŸ—‘ï¸ <b>Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ° ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ°!</b>\n\n"
            f"âŒ Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ° â„–{display_id} Ğ¿Ğ¾Ğ»Ğ½Ğ¾ÑÑ‚ÑŒÑ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ°\n\n"
            f"âš ï¸ <i>Ğ­Ñ‚Ğ¾ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ Ğ½ĞµĞ»ÑŒĞ·Ñ Ğ¾Ñ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ</i>"
        )
    else:
        await message.answer(
            "âŒ <b>ĞÑˆĞ¸Ğ±ĞºĞ° ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸</b>\n\n"
            "Ğ’Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ¸Ñ‡Ğ¸Ğ½Ñ‹:\n"
            "â€¢ Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ° Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°\n"
            "â€¢ ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ğ½Ğ¾Ğ¼ĞµÑ€ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸\n"
            "â€¢ Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ° ÑƒĞ¶Ğµ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ°\n\n"
            "ğŸ’¡ <i>ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ·Ğ°Ğ´Ğ°Ñ‡ Ñ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒÑ /list</i>"
        )


async def on_search(message: Message):
    """ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾Ñ…Ğ¾Ğ¶Ğ¸Ñ… Ğ·Ğ°Ğ´Ğ°Ñ‡ Ğ¿Ğ¾ Ñ‚ĞµĞºÑÑ‚Ñƒ"""
    if " " not in message.text:
        await message.answer(
            "ğŸ” <b>ĞŸĞ¾Ğ¸ÑĞº Ğ·Ğ°Ğ´Ğ°Ñ‡</b>\n"
            "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"
            "âŒ <i>Ğ£ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ Ñ‚ĞµĞºÑÑ‚ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ¸ÑĞºĞ°</i>\n\n"
            "ğŸ’¡ <b>ĞŸÑ€Ğ¸Ğ¼ĞµÑ€:</b> <code>/search ĞºÑƒĞ¿Ğ¸Ñ‚ÑŒ</code>\n"
            "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        )
        return

    query_text = message.text.split(" ", 1)[1]

    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ´Ğ»Ğ¸Ğ½Ñƒ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°
    if len(query_text.strip()) < 2:
        await message.answer(
            "ğŸ” <b>ĞŸĞ¾Ğ¸ÑĞº Ğ·Ğ°Ğ´Ğ°Ñ‡</b>\n"
            "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"
            "âŒ <i>Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ ÑĞ»Ğ¸ÑˆĞºĞ¾Ğ¼ ĞºĞ¾Ñ€Ğ¾Ñ‚ĞºĞ¸Ğ¹</i>\n\n"
            "ğŸ’¡ <i>Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ 2 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ° Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ¸ÑĞºĞ°</i>\n"
            "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        )
        return

    query_vec = utils.make_embedding(query_text)

    # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ²ÑĞµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (Ğ²ĞºĞ»ÑÑ‡Ğ°Ñ ÑÑ‚Ğ°Ñ€Ñ‹Ğµ)
    rows = await database.load_tasks_with_vectors(message.from_user.id)
    if not rows:
        await message.answer(
            "ğŸ” <b>ĞŸĞ¾Ğ¸ÑĞº Ğ·Ğ°Ğ´Ğ°Ñ‡</b>\n"
            "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"
            "ğŸ“­ <i>Ğ£ Ğ²Ğ°Ñ Ğ½ĞµÑ‚ Ğ·Ğ°Ğ´Ğ°Ñ‡ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ¸ÑĞºĞ°</i>\n\n"
            "ğŸ’¡ <i>Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ñ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒÑ /add</i>\n"
            "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        )
        return

    # Ğ¡Ñ‡Ğ¸Ñ‚Ğ°ĞµĞ¼ ĞºĞ¾ÑĞ¸Ğ½ÑƒÑĞ½Ğ¾Ğµ ÑÑ…Ğ¾Ğ´ÑÑ‚Ğ²Ğ¾
    results = []
    for t_id, t_title, t_blob in rows:
        t_vec = utils.blob_to_emb(t_blob)
        if t_vec is not None:
            score = utils.cosine_sim(query_vec, t_vec)
            results.append((score, t_id, t_title))

    # Ğ¡Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ğ¾ ÑƒĞ±Ñ‹Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¿Ğ¾Ñ…Ğ¾Ğ¶ĞµÑÑ‚Ğ¸
    results.sort(key=lambda x: x[0], reverse=True)

    if not results or results[0][0] < 0.1:  # Ğ¼Ğ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¿Ğ¾Ñ€Ğ¾Ğ³ Ğ¿Ğ¾Ñ…Ğ¾Ğ¶ĞµÑÑ‚Ğ¸
        await message.answer(
            f"ğŸ” <b>ĞŸĞ¾Ğ¸ÑĞº: '{query_text}'</b>\n"
            f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"
            f"âŒ <i>ĞĞ¸Ñ‡ĞµĞ³Ğ¾ Ğ¿Ğ¾Ñ…Ğ¾Ğ¶ĞµĞ³Ğ¾ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾</i>\n\n"
            f"ğŸ’¡ <i>ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ´Ñ€ÑƒĞ³Ğ¸Ğµ ĞºĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ ÑĞ»Ğ¾Ğ²Ğ°</i>\n"
            f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        )
        return

    # Ğ‘ĞµÑ€ĞµĞ¼ Ñ‚Ğ¾Ğ¿ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¾Ğ², Ğ½Ğ¾ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ€ĞµĞ»ĞµĞ²Ğ°Ğ½Ñ‚Ğ½Ñ‹Ğµ
    top_results = [r for r in results if r[0] >= 0.3][:5]  # Ğ¼Ğ°ĞºÑĞ¸Ğ¼ÑƒĞ¼ 5 Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¾Ğ²

    if not top_results:
        # Ğ•ÑĞ»Ğ¸ Ğ½ĞµÑ‚ Ğ¾Ñ‡ĞµĞ½ÑŒ Ğ¿Ğ¾Ñ…Ğ¾Ğ¶Ğ¸Ñ…, Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ñ…Ğ¾Ñ‚Ñ Ğ±Ñ‹ Ğ¾Ğ´Ğ½Ñƒ ÑĞ°Ğ¼ÑƒÑ Ğ±Ğ»Ğ¸Ğ·ĞºÑƒÑ
        top_results = results[:1]

    lines = [
        f"ğŸ” <b>ĞŸĞ¾Ğ¸ÑĞº: '{query_text}'</b>",
        "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    ]

    for score, task_id, title in top_results:
        if score >= 0.8:
            similarity_icon = "ğŸ¯"
            similarity_text = "ĞÑ‚Ğ»Ğ¸Ñ‡Ğ½Ğ¾"
        elif score >= 0.6:
            similarity_icon = "âœ…"
            similarity_text = "Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞ¾"
        elif score >= 0.4:
            similarity_icon = "âš ï¸"
            similarity_text = "Ğ¡Ñ€ĞµĞ´Ğ½Ğµ"
        else:
            similarity_icon = "ğŸ¤”"
            similarity_text = "Ğ¡Ğ»Ğ°Ğ±Ğ¾"

        lines.append(f"{similarity_icon} <b>â„–{task_id}:</b> {title}")
        if len(top_results) > 1:
            lines.append(f"   ğŸ“Š Ğ¡Ñ…Ğ¾Ğ´ÑÑ‚Ğ²Ğ¾: {similarity_text} ({score:.1%})")

    # Ğ•ÑĞ»Ğ¸ Ğ½Ğ°ÑˆĞ»Ğ¸ Ğ¾Ñ‡ĞµĞ½ÑŒ Ğ¿Ğ¾Ñ…Ğ¾Ğ¶ÑƒÑ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ, Ğ¿Ñ€ĞµĞ´Ğ»Ğ°Ğ³Ğ°ĞµĞ¼ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ
    if results[0][0] >= 0.8:
        best_match_id = results[0][1]
        lines.extend([
            "",
            "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”",
            f"ğŸ’¡ <b>Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ñ:</b>",
            f"ğŸ¯ Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ° â„–{best_match_id} Ğ¾Ñ‡ĞµĞ½ÑŒ Ğ¿Ğ¾Ñ…Ğ¾Ğ¶Ğ° Ğ½Ğ° Ğ²Ğ°Ñˆ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ",
            f"âœ… ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ: <code>/done {best_match_id}</code> Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ"
        ])

    lines.append("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")

    await message.answer("\n".join(lines))
